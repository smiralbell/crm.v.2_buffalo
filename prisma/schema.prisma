// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NOTA: La autenticación ahora usa variables de entorno (CRM_ADMIN_EMAIL y CRM_ADMIN_PASSWORD)
// No se necesitan tablas users ni sessions en la base de datos

// Modelo Contact - coincide con la estructura existente
model Contact {
  id              Int     @id @default(autoincrement())
  nombre          String?
  email           String? @unique
  instagram_user  String? @unique
  telefono        String?
  empresa         String?
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt
  direccion_fiscal String?
  ciudad          String?
  codigo_postal   String?
  pais            String?
  cif             String?
  iban            String?
  dni             String?
  leads           Lead[]
  messages        Message[]
  tasks           Task[]

  @@map("contacts")
}

// Modelo Lead - adaptado a la estructura existente
model Lead {
  id                Int      @id @default(autoincrement())
  contact_id        Int      @unique
  estado            String?  @default("frio")
  origen_principal  String?
  prioridad         String?  @default("media")
  score             Int?
  ultima_interaccion DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now()) @updatedAt
  pipeline_id       Int?
  pipeline_stage_id Int?
  valor             Decimal? @db.Decimal(10, 2)
  position          Int?
  contact           Contact  @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  // pipeline          Pipeline? @relation(fields: [pipeline_id], references: [id], onDelete: SetNull)
  // pipeline_stage    PipelineStage? @relation(fields: [pipeline_stage_id], references: [id], onDelete: SetNull)
  messages          Message[]
  tasks             Task[]

  @@index([contact_id])
  @@index([estado])
  @@map("leads")
}

// Modelo Message - estructura existente
model Message {
  id          Int      @id @default(autoincrement())
  contact_id  Int
  lead_id     Int?
  canal       String
  direccion   String
  contenido   String
  timestamp   DateTime @default(now())
  raw_payload Json?    @db.JsonB
  contact     Contact  @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  lead        Lead?    @relation(fields: [lead_id], references: [id], onDelete: SetNull)

  @@index([contact_id])
  @@index([lead_id])
  @@map("messages")
}

// Modelo Pipeline - estructura existente (comentado porque ahora usamos PipelineKanban)
// model Pipeline {
//   id         Int            @id @default(autoincrement())
//   nombre     String
//   created_at DateTime       @default(now())
//   stages     PipelineStage[]
//   leads      Lead[]

//   @@map("pipelines")
// }

// Modelo PipelineStage - estructura existente (comentado porque Pipeline está comentado)
// model PipelineStage {
//   id         Int      @id @default(autoincrement())
//   pipeline_id Int
//   nombre     String
//   position   Int
//   pipeline   Pipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
//   leads      Lead[]

//   @@map("pipeline_stages")
// }

// Modelo Task - estructura existente
model Task {
  id         Int       @id @default(autoincrement())
  lead_id    Int?
  contact_id Int?
  tarea      String
  pendiente  Boolean   @default(true)
  fecha      DateTime?
  lead       Lead?     @relation(fields: [lead_id], references: [id], onDelete: SetNull)
  contact    Contact?  @relation(fields: [contact_id], references: [id], onDelete: SetNull)

  @@map("tasks")
}

// ============================================
// SISTEMA DE FACTURACIÓN SIMPLE
// ============================================

// Factura - TODO en una sola tabla
model Invoice {
  id                Int       @id @default(autoincrement())
  invoice_number    String    @unique
  client_name       String
  client_company_name String?   @db.Text
  client_email      String?
  client_address    String?   @db.Text
  client_tax_id     String?
  company_name      String?   @default("BUFFALO AI")
  company_address   String?   @db.Text
  issue_date        DateTime  @default(now()) @db.Date
  due_date          DateTime? @db.Date
  services          Json?     @db.JsonB // Array de servicios
  subtotal          Decimal   @default(0) @db.Decimal(10, 2)
  iva               Decimal   @default(0) @db.Decimal(10, 2)
  total             Decimal   @default(0) @db.Decimal(10, 2)
  status            String    @default("draft") // draft, sent, cancelled
  pdf_drive_file_id String?
  pdf_drive_url     String?   @db.Text
  sent_to_drive     Boolean   @default(false)
  deleted_at        DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  @@index([invoice_number])
  @@index([status])
  @@index([deleted_at])
  @@index([issue_date])
  @@map("invoices")
}

// Plantilla HTML (opcional - solo si quieres guardarla en BD)
model InvoiceTemplate {
  id          Int      @id @default(1)
  html_content String  @db.Text
  updated_at   DateTime @updatedAt

  @@map("invoice_template")
}

// ============================================
// SISTEMA DE PIPELINES KANBAN (MVP)
// ============================================
// Sistema simple tipo GoHighLevel/Holded
// Solo 2 tablas, sin overengineering

model PipelineKanban {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  entity_type String   // 'client' | 'contact'
  created_at  DateTime @default(now())

  cards       PipelineCard[]

  @@map("pipelines")
}

model PipelineCard {
  id            String    @id @default(uuid()) @db.Uuid
  pipeline_id   String    @db.Uuid
  entity_id     String    @db.Text // ID del contacto o cliente (referencia externa) - almacenado como TEXT
  entity_type   String    // 'client' | 'contact'
  stage         String    // Nombre de la columna
  stage_color   String?   // Color de la columna (hex) - nullable porque puede no tener default en BD
  position      Int       // Orden dentro de la columna - sin default porque puede no tenerlo en BD
  tags          String[]  // Array de etiquetas
  capture_date  DateTime? // Fecha de captación del lead
  amount        Decimal? @db.Decimal(10, 2) // Cantidad de dinero del objeto
  notes         String?  @db.Text // Notas adicionales
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  deleted_at    DateTime?

  pipeline      PipelineKanban @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)

  @@index([pipeline_id])
  @@index([stage])
  @@index([entity_id, entity_type])
  @@index([deleted_at])
  @@index([pipeline_id, stage, position])
  @@map("pipeline_cards")
}

// ============================================
// SISTEMA DE FINANZAS
// ============================================
// Gestión financiera visual y manual
// NO contabilidad oficial - solo para decisiones

// Gastos fijos mensuales (se repiten automáticamente)
model FixedExpense {
  id          Int      @id @default(autoincrement())
  name        String
  amount      Decimal  @db.Decimal(10, 2)
  has_iva     Boolean  @default(false)
  iva_percent Decimal? @db.Decimal(5, 2) // % IVA (21, 10, 4, etc.)
  is_active   Boolean  @default(true)
  tags        String[] // Array de etiquetas
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  @@index([is_active, deleted_at])
  @@map("fixed_expenses")
}

// Gastos manuales (freelancers, proveedores)
model Expense {
  id          Int      @id @default(autoincrement())
  name        String
  date_start  DateTime @db.Date // Fecha inicio del rango
  date_end    DateTime @db.Date // Fecha fin del rango
  base_amount Decimal  @db.Decimal(10, 2) // Base sin IVA
  iva_amount  Decimal  @default(0) @db.Decimal(10, 2) // IVA
  total_amount Decimal @db.Decimal(10, 2) // Total con IVA
  tags        String[] // Array de etiquetas
  person_name String?  // Nombre de la persona/proveedor
  project     String?  // Proyecto asociado (opcional)
  client_name String?  // Cliente asociado (opcional)
  notes       String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  @@index([date_start])
  @@index([date_end])
  @@index([deleted_at])
  @@map("expenses")
}

// Nóminas / Pagos a socios (sin IVA)
model Salary {
  id          Int      @id @default(autoincrement())
  person_name String
  date        DateTime @db.Date
  amount      Decimal  @db.Decimal(10, 2)
  tags        String[] // Array de etiquetas
  notes       String?  @db.Text
  created_at DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  @@index([date])
  @@index([deleted_at])
  @@map("salaries")
}

// Ingresos (facturas reales o estimadas)
model FinancialIncome {
  id          Int      @id @default(autoincrement())
  client_name String
  date        DateTime @db.Date
  base_amount Decimal  @db.Decimal(10, 2) // Base sin IVA
  iva_amount  Decimal  @default(0) @db.Decimal(10, 2) // IVA
  total_amount Decimal @db.Decimal(10, 2) // Total con IVA
  status      String   @default("pending") // pending, paid, estimated
  project     String?  // Proyecto asociado (opcional)
  invoice_id  Int?     // ID de factura si está vinculada (opcional)
  notes       String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  @@index([date])
  @@index([status])
  @@index([deleted_at])
  @@map("financial_incomes")
}

// Configuración financiera (IVA, impuesto sociedades)
model FinancialSettings {
  id                    Int      @id @default(1)
  corporate_tax_percent  Decimal  @default(25) @db.Decimal(5, 2) // % Impuesto sociedades (15%, 25%, etc.)
  updated_at             DateTime @updatedAt

  @@map("financial_settings")
}
